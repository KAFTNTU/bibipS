<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RoboControl Car (SLIP)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>

    <style>
        /* --- GLOBAL STYLES --- */
        body {
            overscroll-behavior: none;
            touch-action: none;
            user-select: none;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: #0f172a;
            color: white;
            overflow: hidden; 
        }
        
        .glass-header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        /* --- JOYSTICK --- */
        #joystick-container { 
            position: relative; 
            width: 280px; 
            height: 280px; 
            margin: 0 auto 5vh auto; 
        }
        #joystick-base {
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 70%);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.6), inset 0 0 20px rgba(0, 0, 0, 0.8);
            position: relative;
        }
        #joystick-stick {
            position: absolute; width: 90px; height: 90px;
            background: radial-gradient(circle at 30% 30%, #3b82f6, #1d4ed8);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
            cursor: grab; z-index: 10;
            transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
        }
        #joystick-stick.snap-back { transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #joystick-stick::after {
            content: ''; position: absolute; top: 20px; left: 20px; width: 25px; height: 25px;
            background: rgba(255,255,255,0.2); border-radius: 50%;
        }
        #joystick-stick.braking {
            background: radial-gradient(circle at 30% 30%, #ef4444, #b91c1c);
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.6);
        }

        .lock-btn { transition: all 0.3s; }
        .gyro-active { background-color: #8b5cf6 !important; box-shadow: 0 0 15px #8b5cf6; color: white !important; border-color: #8b5cf6 !important; animation: pulse-purple 2s infinite; }
        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }

        /* --- SPEED SLIDER --- */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px rgba(59,130,246,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }

        /* --- DUAL JOYSTICK --- */
        .joy-dual-container { width: 140px; height: 140px; margin: 0 auto; position: relative; }
        .joy-dual-base { width: 100%; height: 100%; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 80%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 50%; box-shadow: inset 0 0 15px rgba(0,0,0,0.8); position: relative; touch-action: none; }
        .joy-dual-stick { position: absolute; width: 50px; height: 50px; background: radial-gradient(circle at 30% 30%, #a855f7, #7e22ce); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 10; pointer-events: none; }
        .joy-dual-stick.snap { transition: transform 0.2s; }
        .trig-btn { width: 60px; height: 60px; border-radius: 50%; background: #1e293b; border: 2px solid #334155; color: #64748b; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.1s; box-shadow: 0 4px 0 #0f172a; }
        .trig-btn:active { transform: translateY(4px); box-shadow: none; background: #7e22ce; border-color: #a855f7; color: white; }

        /* --- BLOCKLY --- */
        #blocklyDiv { position: absolute; top: 64px; left: 0; right: 0; bottom: 64px; background-color: #0f172a !important; }
        .blocklySvg { background-color: transparent !important; }
        .blocklyToolboxDiv { border: 1px solid rgba(255, 255, 255, 0.15); position: absolute !important; bottom: 40px !important; left: 50% !important; transform: translateX(-50%) !important; top: auto !important; height: 64px !important; width: fit-content !important; min-width: 320px; max-width: 95vw; display: flex !important; flex-direction: row !important; align-items: center; justify-content: center; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 40; padding: 0 10px; }
        .blocklyTreeRow { height: 48px !important; padding: 0 15px !important; margin: 0 4px !important; border-radius: 10px !important; cursor: pointer; display: flex; align-items: center; justify-content: center; border: 1px solid transparent; }
        .blocklyTreeLabel { font-family: 'Segoe UI', sans-serif; font-weight: 700; font-size: 13px !important; }
        .blocklyToolboxDiv::-webkit-scrollbar, .blocklyFlyoutScrollbar, .blocklyScrollbarHandle, .blocklyScrollbarBackground, .blocklyZoom { display: none !important; }

        /* --- RUN BUTTON --- */
        .run-fab { position: absolute; bottom: 120px; right: 20px; width: 80px; height: 80px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.1); background: #22c55e; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .run-fab:active { transform: scale(0.9); }
        .run-fab.running { background: #ef4444; animation: pulse-red 2s infinite; }
        .run-fab i { font-size: 32px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* UI Elements */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; display: inline-block; transition: all 0.3s;}
        .connected { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .nav-btn { color: #64748b; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; position: relative; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: #94a3b8; }
        .nav-btn.active { color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        
        .log-line { font-family: 'Courier New', monospace; font-size: 11px; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-tx { color: #60a5fa; } .log-rx { color: #34d399; } .log-err { color: #f87171; }
        .key-hint { display: inline-block; padding: 2px 6px; background: #334155; border-radius: 4px; font-family: monospace; font-size: 10px; color: #94a3b8; border-bottom: 2px solid #1e293b; }
        
        .tune-check { display: flex; align-items: center; justify-content: space-between; background: #1e293b; padding: 10px; border-radius: 8px; border: 1px solid #334155; }
        .toggle-checkbox { appearance: none; width: 40px; height: 20px; background: #334155; border-radius: 20px; position: relative; cursor: pointer; transition: 0.3s; }
        .toggle-checkbox::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-checkbox:checked { background: #3b82f6; }
        .toggle-checkbox:checked::after { transform: translateX(20px); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- === HEADER === -->
    <header class="h-16 glass-header flex items-center justify-between px-4 z-50 absolute top-0 w-full">
        <div class="flex items-center gap-2">
            <span id="statusDot" class="status-dot"></span>
            <span id="statusText" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest hidden sm:block">OFFLINE</span>
        </div>
        
        <nav class="flex items-center gap-1 bg-slate-800/50 p-1 rounded-xl border border-slate-700/50">
            <button onclick="switchView('view-joystick', this)" class="nav-btn active" title="–ü—É–ª—å—Ç">
                <i class="fa-solid fa-gamepad text-lg"></i>
            </button>
            <button onclick="switchView('view-builder', this)" class="nav-btn" title="–ë–ª–æ–∫–∏">
                <i class="fa-solid fa-puzzle-piece text-lg"></i>
            </button>
            <button onclick="startDualMode(this)" class="nav-btn text-purple-400 hover:text-purple-300" title="Dual Mode">
                <i class="fa-solid fa-gamepad text-lg"></i><i class="fa-solid fa-gamepad text-lg -ml-2 text-purple-600"></i>
            </button>
            <div class="w-px h-6 bg-slate-700 mx-1"></div>
            <button onclick="openPassModal()" class="nav-btn text-emerald-500/80 hover:text-emerald-400" title="–ü–∞—Ä–æ–ª—å">
                <i class="fa-solid fa-lock text-lg"></i>
            </button>
            <button onclick="toggleLogModal()" class="nav-btn text-yellow-500/80 hover:text-yellow-400" title="–õ–æ–≥">
                <i class="fa-solid fa-book text-lg"></i>
            </button>
        </nav>
        
        <button id="btConnect" class="w-10 h-10 rounded-full bg-blue-600 active:bg-blue-700 hover:bg-blue-500 text-white shadow-lg flex items-center justify-center transition-all border border-blue-400/30">
            <i class="fa-brands fa-bluetooth-b text-lg"></i>
        </button>
    </header>

    <!-- === MAIN CONTENT === -->
    <main class="flex-1 relative overflow-hidden bg-gradient-to-br from-slate-900 to-slate-950 pt-16">
        
        <!-- --- VIEW 1: JOYSTICK --- -->
        <section id="view-joystick" class="absolute inset-0 flex flex-col items-center justify-center p-4 transition-opacity duration-300">
            
            <!-- Joystick -->
            <div id="joystick-container" class="mb-2">
                <div id="joystick-base">
                    <div id="joystick-stick" class="snap-back"></div>
                </div>
            </div>
            
            <div class="text-center mb-4 opacity-50 hidden md:block">
                <span class="key-hint">W</span> <span class="key-hint">A</span> <span class="key-hint">S</span> <span class="key-hint">D</span> –¥–ª—è —Ä—É—Ö—É
            </div>

            <!-- Controls Cluster -->
            <div class="w-full max-w-xs flex flex-col gap-3 bg-slate-800/40 p-4 rounded-2xl border border-slate-700/30 backdrop-blur-sm">
                
                <!-- Monitors & Gyro -->
                <div class="flex items-center justify-between gap-4">
                    <div class="bg-slate-900 px-3 py-1.5 rounded-lg border border-slate-700 text-center flex-1">
                        <span class="text-[10px] text-green-500 font-bold mr-1">L</span>
                        <span id="motorLDisplay" class="text-blue-400 font-mono font-bold">0</span>
                    </div>
                    
                    <button id="gyroBtn" class="lock-btn w-10 h-10 rounded-full bg-slate-700 text-slate-400 flex items-center justify-center shadow-md border border-slate-600 hover:bg-slate-600 active:scale-95" onclick="toggleGyro()" title="–ì—ñ—Ä–æ—Å–∫–æ–ø (–Ω–∞—Ç–∏—Å–Ω–∏ —â–æ–± –æ–±–Ω—É–ª–∏—Ç–∏)">
                        <i class="fa-solid fa-mobile-screen-button text-sm"></i>
                    </button>

                    <div class="bg-slate-900 px-3 py-1.5 rounded-lg border border-slate-700 text-center flex-1">
                        <span class="text-[10px] text-green-500 font-bold mr-1">R</span>
                        <span id="motorRDisplay" class="text-blue-400 font-mono font-bold">0</span>
                    </div>
                </div>

                <!-- Speed Slider -->
                <div class="pt-2 border-t border-white/5">
                    <div class="flex justify-between text-[10px] text-slate-400 mb-1 uppercase tracking-wide">
                        <span>–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å</span>
                        <span id="speedVal">100%</span>
                    </div>
                    <input type="range" id="speedSlider" min="10" max="100" value="100" step="10">
                </div>
                
                 <!-- Tuning Button -->
                <button onclick="document.getElementById('tuningModal').classList.remove('hidden')" class="w-full py-2 mt-1 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs font-bold text-slate-300 border border-slate-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-sliders"></i> –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–æ—Ç–æ—Ä—ñ–≤
                </button>

                <!-- HEX Display -->
                <div class="bg-black/40 px-3 py-1 rounded text-[10px] font-mono tracking-widest text-slate-400 border border-slate-800/50 text-center mt-2">
                    HEX: <span id="joyHex" class="text-yellow-500 font-bold">00 00 0A</span>
                </div>
            </div>
        </section>


        <!-- --- VIEW 2: BUILDER (SCRATCH) --- -->
        <section id="view-builder" class="absolute inset-0 flex flex-col hidden opacity-0 transition-opacity duration-300">
            
            <div class="h-10 bg-slate-800/90 mt-2 mx-2 rounded-lg flex items-center justify-between px-4 border border-slate-700 z-10 shadow-lg absolute top-4 right-4 left-4 sm:left-auto sm:w-auto">
                <span class="text-xs text-slate-400 font-bold"><i class="fa-solid fa-eye mr-2"></i>S:</span>
                <span id="sensorValDisplay" class="font-mono text-emerald-400 font-bold text-lg ml-2">--</span>
            </div>

            <!-- Blockly Div -->
            <div id="blocklyDiv" class="flex-1 mt-0"></div>
            
            <!-- EXTERNAL START BUTTON -->
            <button id="globalRunBtn" class="run-fab" onclick="toggleRunState()">
                <i class="fa-solid fa-play ml-1" id="runIcon"></i>
            </button>
        </section>

        <!-- --- VIEW 3: DUAL MODE --- -->
        <section id="view-dual" class="absolute inset-0 hidden opacity-0 flex flex-col items-center justify-center">
             <div class="absolute top-0 w-full h-12 bg-slate-900/50 flex justify-between items-center px-6 border-b border-white/5 backdrop-blur-sm z-10">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
                    <span class="text-xs text-purple-400 font-bold tracking-[0.2em] uppercase">Dual Stick Mode</span>
                </div>
                <button onclick="openProtocolModal()" class="text-xs text-slate-400 hover:text-white flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full border border-slate-700 hover:border-slate-500 transition-all">
                    <i class="fa-solid fa-gear"></i> –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏
                </button>
            </div>

            <div class="w-full flex justify-around items-center px-4 relative mt-10">
                <!-- Left -->
                <div class="flex flex-col items-center gap-6">
                    <div class="relative group">
                        <button id="btnL" class="trig-btn" onmousedown="setBtn('L', 1)" onmouseup="setBtn('L', 0)" ontouchstart="setBtn('L', 1)" ontouchend="setBtn('L', 0)">L</button>
                         <div class="absolute -top-8 left-1/2 -translate-x-1/2 text-[10px] bg-slate-900 px-2 py-1 rounded border border-slate-700 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="configBtn('L')">VAL: <span id="valDispL">1</span></div>
                    </div>
                    <div id="joyL-container" class="joy-dual-container">
                        <div id="joyL-base" class="joy-dual-base">
                            <div id="joyL-stick" class="joy-dual-stick snap"></div>
                        </div>
                    </div>
                </div>

                <!-- Right -->
                <div class="flex flex-col items-center gap-6">
                    <div class="relative group">
                        <button id="btnR" class="trig-btn" onmousedown="setBtn('R', 1)" onmouseup="setBtn('R', 0)" ontouchstart="setBtn('R', 1)" ontouchend="setBtn('R', 0)">R</button>
                        <div class="absolute -top-8 left-1/2 -translate-x-1/2 text-[10px] bg-slate-900 px-2 py-1 rounded border border-slate-700 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="configBtn('R')">VAL: <span id="valDispR">1</span></div>
                    </div>
                    <div id="joyR-container" class="joy-dual-container">
                        <div id="joyR-base" class="joy-dual-base">
                            <div id="joyR-stick" class="joy-dual-stick snap"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 bg-black/40 px-4 py-2 rounded text-xs font-mono text-purple-400 border border-slate-800">
                HEX: <span id="dualPacketHex">--</span>
            </div>
        </section>
    </main>


    <!-- === MODALS === -->
    
    <!-- Tuning Modal -->
    <div id="tuningModal" class="fixed inset-0 bg-black/90 z-[80] hidden flex items-center justify-center backdrop-blur-md p-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-2xl shadow-2xl border border-slate-700 p-5">
            <h3 class="text-lg font-bold text-white mb-4 text-center">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —à–∞—Å—ñ</h3>
            
            <div class="space-y-4">
                <!-- Trim -->
                <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                    <div class="flex justify-between text-xs text-slate-400 mb-2">
                        <span>L (–í–ª—ñ–≤–æ)</span>
                        <span class="font-bold text-white">–ë–ê–õ–ê–ù–°</span>
                        <span>R (–í–ø—Ä–∞–≤–æ)</span>
                    </div>
                    <input type="range" id="trimSlider" min="-50" max="50" value="0" step="1" oninput="updateTrimDisplay(this.value)">
                    <div class="text-center text-xs text-blue-400 font-mono mt-1" id="trimValueDisplay">0</div>
                    <p class="text-[10px] text-slate-500 mt-1 text-center">–ó–º—ñ—Å—Ç—ñ—Ç—å, —è–∫—â–æ –º–∞—à–∏–Ω–∫—É –∑–∞–Ω–æ—Å–∏—Ç—å –≤ –±—ñ–∫</p>
                </div>

                <!-- Invert -->
                <div class="space-y-2">
                    <label class="tune-check">
                        <span class="text-sm text-slate-300">–†–µ–≤–µ—Ä—Å –õ—ñ–≤–æ–≥–æ (L)</span>
                        <input type="checkbox" id="invLCheck" class="toggle-checkbox" onchange="saveTuning()">
                    </label>
                    <label class="tune-check">
                        <span class="text-sm text-slate-300">–†–µ–≤–µ—Ä—Å –ü—Ä–∞–≤–æ–≥–æ (R)</span>
                        <input type="checkbox" id="invRCheck" class="toggle-checkbox" onchange="saveTuning()">
                    </label>
                </div>
            </div>

            <button onclick="document.getElementById('tuningModal').classList.add('hidden')" class="w-full mt-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-500 shadow-lg">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–∞ –∑–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>

    <div id="passModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center backdrop-blur-md p-4">
        <div class="bg-slate-900 p-6 rounded-2xl w-full max-w-sm shadow-2xl border border-slate-700">
            <h3 class="text-lg font-bold text-white mb-6 text-center tracking-wide">–î–û–°–¢–£–ü</h3>
            <input type="text" id="passInput" class="w-full bg-slate-950 border border-slate-700 rounded-xl pl-10 pr-4 py-4 text-white focus:border-blue-500 outline-none text-center text-xl tracking-[0.5em] font-mono" placeholder="****">
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="closePassModal()" class="py-3 rounded-xl bg-slate-800 text-slate-400 hover:bg-slate-700">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button onclick="sendPassword()" class="py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-500 shadow-lg">OK</button>
            </div>
        </div>
    </div>

    <div id="valueConfigModal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-900 p-5 rounded-xl border border-slate-700 z-50 shadow-2xl w-64">
        <h3 class="text-white text-sm font-bold mb-2">–ó–Ω–∞—á–µ–Ω–Ω—è (0-255)</h3>
        <input type="number" id="btnValInput" class="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white mb-3 text-center">
        <div class="flex gap-2">
            <button onclick="saveBtnConfig()" class="flex-1 bg-purple-600 text-white text-xs py-2 rounded">OK</button>
            <button onclick="document.getElementById('valueConfigModal').classList.add('hidden')" class="flex-1 bg-slate-700 text-white text-xs py-2 rounded">X</button>
        </div>
    </div>

    <div id="protocolModal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center backdrop-blur-md p-4">
        <div class="bg-slate-900 w-full max-w-sm h-[80vh] rounded-2xl shadow-2xl border border-slate-700 flex flex-col">
            <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                <h3 class="font-bold text-white">–ü—Ä–æ—Ç–æ–∫–æ–ª Dual Mode</h3>
                <button onclick="document.getElementById('protocolModal').classList.add('hidden')" class="text-slate-400"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="byteList" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
            <div class="p-4 border-t border-slate-800 flex gap-2">
                <button onclick="addByte()" class="flex-1 bg-slate-800 text-blue-400 py-2 rounded-lg border border-dashed border-slate-600">–î–æ–¥–∞—Ç–∏</button>
                <button onclick="saveProtocol()" class="flex-1 bg-blue-600 text-white font-bold py-2 rounded-lg">–û–ö</button>
            </div>
        </div>
    </div>

    <div id="logModal" class="fixed inset-0 bg-black/50 z-40 hidden flex items-end sm:items-center justify-center backdrop-blur-sm sm:p-4">
        <div class="bg-slate-900 w-full sm:max-w-md h-2/3 sm:h-[500px] sm:rounded-2xl rounded-t-2xl shadow-2xl border border-slate-700 flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-slate-800">
                <h3 class="text-sm font-bold text-yellow-500 flex items-center gap-2"><i class="fa-solid fa-book"></i> –°–ò–°–¢–ï–ú–ù–ò–ô –õ–û–ì</h3>
                <div class="flex gap-2">
                    <button onclick="clearLog()" class="text-slate-500 hover:text-white text-xs px-2"><i class="fa-solid fa-trash"></i></button>
                    <button onclick="toggleLogModal()" class="text-slate-500 hover:text-white text-lg"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div id="logContainer" class="flex-1 overflow-y-auto p-4 space-y-1 bg-black/20 font-mono text-xs">
                <div class="text-slate-500 italic">-- –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π --</div>
            </div>
        </div>
    </div>

    <!-- XML Blocks -->
    <xml id="toolbox" style="display: none">
        <category name="üåü –ì–æ—Ç–æ–≤—ñ –∑–±—ñ—Ä–∫–∏" colour="#fbbf24">
            <!-- –ó–±—ñ—Ä–∫–∞: –á–∑–¥–∞ –∫–≤–∞–¥—Ä–∞—Ç–æ–º (Square) -->
            <block type="start_hat">
                <next>
                    <block type="controls_repeat_ext">
                        <value name="TIMES"><shadow type="math_number"><field name="NUM">4</field></shadow></value>
                        <statement name="DO">
                            <block type="robot_move">
                                <value name="L"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                                <value name="R"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                                <next>
                                    <block type="wait_seconds">
                                        <field name="SECONDS">1</field>
                                        <next>
                                            <block type="robot_move">
                                                <value name="L"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                                                <value name="R"><shadow type="math_number"><field name="NUM">-100</field></shadow></value>
                                                <next>
                                                    <block type="wait_seconds">
                                                        <field name="SECONDS">0.5</field>
                                                    </block>
                                                </next>
                                            </block>
                                        </next>
                                    </block>
                                </next>
                            </block>
                        </statement>
                        <next><block type="robot_stop"></block></next>
                    </block>
                </next>
            </block>

            <!-- –ó–±—ñ—Ä–∫–∞: –ó–º—ñ–π–∫–∞ (Snake) -->
            <block type="start_hat">
                <next>
                    <block type="controls_repeat_ext">
                        <value name="TIMES"><shadow type="math_number"><field name="NUM">3</field></shadow></value>
                        <statement name="DO">
                            <block type="robot_move">
                                <value name="L"><shadow type="math_number"><field name="NUM">50</field></shadow></value>
                                <value name="R"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                                <next>
                                    <block type="wait_seconds">
                                        <field name="SECONDS">1</field>
                                        <next>
                                            <block type="robot_move">
                                                <value name="L"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                                                <value name="R"><shadow type="math_number"><field name="NUM">50</field></shadow></value>
                                                <next>
                                                    <block type="wait_seconds">
                                                        <field name="SECONDS">1</field>
                                                    </block>
                                                </next>
                                            </block>
                                        </next>
                                    </block>
                                </next>
                            </block>
                        </statement>
                        <next><block type="robot_stop"></block></next>
                    </block>
                </next>
            </block>

            <!-- –ó–±—ñ—Ä–∫–∞: –†–æ–∑–≤—ñ–¥–∫–∞ (Scout) -->
            <block type="start_hat">
                <next>
                    <block type="robot_move">
                        <value name="L"><shadow type="math_number"><field name="NUM">80</field></shadow></value>
                        <value name="R"><shadow type="math_number"><field name="NUM">80</field></shadow></value>
                        <next>
                            <block type="wait_seconds">
                                <field name="SECONDS">2</field>
                                <next>
                                    <block type="robot_stop">
                                        <next>
                                            <block type="wait_seconds">
                                                <field name="SECONDS">1</field>
                                                <next>
                                                    <block type="go_home"></block>
                                                </next>
                                            </block>
                                        </next>
                                    </block>
                                </next>
                            </block>
                        </next>
                    </block>
                </next>
            </block>

            <!-- –ó–±—ñ—Ä–∫–∞: üì¶ –î–æ—Å—Ç–∞–≤–∫–∞ –≤–∞–Ω—Ç–∞–∂—É (Delivery) -->
            <block type="start_hat">
                <next>
                    <block type="robot_move">
                        <value name="L"><shadow type="math_number"><field name="NUM">60</field></shadow></value>
                        <value name="R"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                        <next>
                            <block type="wait_seconds">
                                <field name="SECONDS">1.5</field>
                                <next>
                                    <block type="robot_move">
                                        <value name="L"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                                        <value name="R"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                                        <next>
                                            <block type="wait_seconds">
                                                <field name="SECONDS">2</field>
                                                <next>
                                                    <block type="robot_stop">
                                                        <next>
                                                            <block type="wait_seconds">
                                                                <field name="SECONDS">3</field>
                                                                <next>
                                                                    <block type="go_home"></block>
                                                                </next>
                                                            </block>
                                                        </next>
                                                    </block>
                                                </next>
                                            </block>
                                        </next>
                                    </block>
                                </next>
                            </block>
                        </next>
                    </block>
                </next>
            </block>
        </category>
        <category name="–ú–∞—à–∏–Ω–∫–∞" colour="#4C97FF">
            <block type="start_hat"></block>
            <block type="robot_move">
                <value name="L"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                <value name="R"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
            </block>
            <block type="move_3_motors"></block>
            <block type="robot_stop"></block>
        </category>
        <category name="–õ–æ–≥—ñ–∫–∞" colour="%{BKY_LOGIC_HUE}">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
        </category>
        <category name="–¶–∏–∫–ª–∏" colour="%{BKY_LOOPS_HUE}">
            <block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">4</field></shadow></value></block>
            <block type="controls_whileUntil"></block>
        </category>
        <category name="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" colour="%{BKY_MATH_HUE}">
            <block type="math_number"></block>
            <block type="math_random_int"></block>
            <block type="sensor_get"></block>
        </category>
        <category name="–ß–∞—Å" colour="#FFBF00">
            <block type="wait_seconds"><field name="SECONDS">1</field></block>
            <block type="go_home"></block>
        </category>
    </xml>

    <script>
        // === üé® –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ö–û–õ–¨–û–†–Ü–í ===
        const THEME_CONFIG = {
            menuBg: '#1f2937',      
            menuText: '#ffffff',    
            menuSelected: '#1f2937',
            flyoutBg: '#1f2937',    
            flyoutOpacity: 0.95     
        };

        // === GLOBAL STATE ===
        let isConnected = false;
        let device, characteristic;
        let isGyroEnabled = false;
        let activeView = 'view-joystick';
        
        // Gyro Calibration
        let gyroCalibrated = false;
        let gyroOffset = { x: 0, y: 0 };
        
        let currentL = 0;
        let currentR = 0;
        let speedMultiplier = 1.0; 
        
        // Track raw joy position to update on speed change
        let lastJoyX = 0;
        let lastJoyY = 0;
        
        // TUNING STATE
        let tuning = { trim: 0, invertL: false, invertR: false };
        try {
            const saved = localStorage.getItem('roboTuning');
            if(saved) tuning = JSON.parse(saved);
        } catch(e) {}
        
        // Init UI
        document.getElementById('trimSlider').value = tuning.trim;
        document.getElementById('trimValueDisplay').innerText = tuning.trim > 0 ? `R+${tuning.trim}` : (tuning.trim < 0 ? `L${tuning.trim}` : '0');
        document.getElementById('invLCheck').checked = tuning.invertL;
        document.getElementById('invRCheck').checked = tuning.invertR;

        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const btnConnect = document.getElementById('btConnect');
        const motorLDisplay = document.getElementById('motorLDisplay');
        const motorRDisplay = document.getElementById('motorRDisplay');
        const joyHex = document.getElementById('joyHex');
        const speedSlider = document.getElementById('speedSlider');
        const speedVal = document.getElementById('speedVal');

        function updateTrimDisplay(val) {
            tuning.trim = parseInt(val);
            document.getElementById('trimValueDisplay').innerText = tuning.trim > 0 ? `R+${tuning.trim}` : (tuning.trim < 0 ? `L${tuning.trim}` : '0');
            saveTuning();
        }

        function saveTuning() {
            tuning.trim = parseInt(document.getElementById('trimSlider').value);
            tuning.invertL = document.getElementById('invLCheck').checked;
            tuning.invertR = document.getElementById('invRCheck').checked;
            localStorage.setItem('roboTuning', JSON.stringify(tuning));
        }

        // === HEARTBEAT ===
        setInterval(() => {
            if (isConnected && activeView === 'view-joystick') {
                sendDrivePacket(currentL, currentR);
            }
        }, 100);

        // === SLIP PROTOCOL (MANDATORY) ===
        const SLIP_END = 0xC0;
        const SLIP_ESC = 0xDB;
        const SLIP_ESC_END = 0xDC;
        const SLIP_ESC_ESC = 0xDD;

        function slipEncode(dataArray) {
            let encoded = [];
            for(let byte of dataArray) {
                if(byte === SLIP_END) { encoded.push(SLIP_ESC, SLIP_ESC_END); }
                else if(byte === SLIP_ESC) { encoded.push(SLIP_ESC, SLIP_ESC_ESC); }
                else { encoded.push(byte); }
            }
            encoded.push(SLIP_END);
            return new Uint8Array(encoded);
        }

        // === BLUETOOTH CORE ===
        async function sendDrivePacket(l, r) {
            if (!isConnected || !characteristic) return;

            // Packet logic is now pre-calculated in updateTankLogic for display sync
            // but we send the *current global* values which are already processed.
            // However, sendDrivePacket was doing the processing before.
            // Let's make sendDrivePacket just send the raw values it gets, 
            // OR use the global currentL/currentR.
            // To be safe and consistent with heartbeat, we use args l, r.
            
            // Cast to Int8 for correct binary representation of negative numbers
            const raw = new Int8Array([l, r, 10]);
            const uintView = new Uint8Array(raw.buffer); 
            
            const slipPacket = slipEncode(uintView);
            
            try { await characteristic.writeValue(slipPacket); } catch(e) { log(e, 'err'); }
        }

        async function sendRawPacket(data) {
             if (!isConnected || !characteristic) return;
             // If raw packet, assume user handles structure, but we wrap in SLIP for transport
             try { await characteristic.writeValue(slipEncode(data)); } catch(e) {}
        }

        async function sendTextData(str) {
            if (!isConnected || !characteristic) return;
            const raw = new TextEncoder().encode(str + '\n');
            const slipPacket = slipEncode(raw);
            try { await characteristic.writeValue(slipPacket); log(`Cmd: ${str}`, 'tx'); } catch(e) { log(e, 'err'); }
        }

        async function bt_move3(m1, m2, m3) {
            if(typeof isConnected !== 'undefined' && isConnected) {
                // Custom 3 motor packet wrapped in SLIP
                const raw = new Int8Array([parseInt(m1), parseInt(m2), parseInt(m3), 10]);
                try { await characteristic.writeValue(slipEncode(new Uint8Array(raw.buffer))); } catch(e){}
            }
        }

        // Logging
        function log(msg, type = 'info') {
            const container = document.getElementById('logContainer');
            const el = document.createElement('div');
            el.classList.add('log-line');
            if(type === 'tx') el.classList.add('log-tx');
            else if(type === 'rx') el.classList.add('log-rx');
            else if(type === 'err') el.classList.add('log-err');
            else el.classList.add('text-slate-400');
            el.innerText = msg;
            container.appendChild(el);
            container.scrollTop = container.scrollHeight;
        }
        function clearLog() { document.getElementById('logContainer').innerHTML = ''; }
        function toggleLogModal() { document.getElementById('logModal').classList.toggle('hidden'); }

        // Bluetooth Connect
        btnConnect.addEventListener('click', async () => {
            if(isConnected) { if(device) device.gatt.disconnect(); return; }
            try {
                log('Scanning...', 'info');
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [0xFFE0, "6e400001-b5a3-f393-e0a9-e50e24dcca9e"]
                });
                device.addEventListener('gattserverdisconnected', () => {
                    isConnected = false; statusDot.classList.remove('connected'); statusText.innerText = "OFFLINE";
                    btnConnect.classList.remove('bg-red-600'); btnConnect.classList.add('bg-blue-600');
                    log('Disconnected', 'err');
                });
                const server = await device.gatt.connect();
                let service;
                try { service = await server.getPrimaryService(0xFFE0); characteristic = await service.getCharacteristic(0xFFE1); } 
                catch(e) { service = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e"); characteristic = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e"); }

                try {
                    await characteristic.startNotifications();
                    characteristic.addEventListener('characteristicvaluechanged', (e) => {
                        // Receive Data (Text based for compatibility)
                        const str = new TextDecoder().decode(e.target.value).trim();
                        log(str, 'rx');
                        let val = parseFloat(str.replace('S:', ''));
                        if(!isNaN(val)) { window.sensorVal = val; document.getElementById('sensorValDisplay').innerText = val; }
                    });
                } catch(e){}

                isConnected = true; statusDot.classList.add('connected'); statusText.innerText = "ONLINE";
                btnConnect.classList.remove('bg-blue-600'); btnConnect.classList.add('bg-red-600');
                log('Connected!', 'info');
            } catch(e) { log(e, 'err'); }
        });

        // Navigation
        function switchView(viewId, btnElement) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            
            ['view-joystick', 'view-builder', 'view-dual'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.add('hidden');
                el.classList.remove('opacity-100');
                el.classList.add('opacity-0');
            });
            const target = document.getElementById(viewId);
            target.classList.remove('hidden');
            setTimeout(() => { target.classList.remove('opacity-0'); target.classList.add('opacity-100'); }, 10);
            
            activeView = viewId;
            if(viewId !== 'view-joystick' && isGyroEnabled) toggleGyro();
            if(viewId === 'view-builder' && typeof Blockly !== 'undefined') setTimeout(() => Blockly.svgResize(workspace), 100);
        }
        function startDualMode(btn) { switchView('view-dual', btn); }

        // Pass Modal
        function openPassModal() { document.getElementById('passModal').classList.remove('hidden'); }
        function closePassModal() { document.getElementById('passModal').classList.add('hidden'); }
        function sendPassword() {
            const pass = document.getElementById('passInput').value;
            if (pass) { sendTextData(`PASS:${pass}`); document.getElementById('passInput').value = ''; closePassModal(); }
        }

        // Joystick Logic
        const stick = document.getElementById('joystick-stick');
        const base = document.getElementById('joystick-base');
        const gyroBtn = document.getElementById('gyroBtn');
        let dragging = false;
        let joyCenter = { x: 0, y: 0 };
        const maxDist = 90;

        speedSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            speedVal.innerText = val + '%';
            speedMultiplier = val / 100;
            // Update immediately using last known joy pos
            updateTankLogic(lastJoyX, lastJoyY);
        });

        // Keyboard
        const keys = { w: false, a: false, s: false, d: false };
        document.addEventListener('keydown', (e) => { if(activeView!=='view-joystick')return; const k=e.key.toLowerCase(); if(keys.hasOwnProperty(k)){keys[k]=true; updateKeyboardLogic();} });
        document.addEventListener('keyup', (e) => { if(activeView!=='view-joystick')return; const k=e.key.toLowerCase(); if(keys.hasOwnProperty(k)){keys[k]=false; updateKeyboardLogic();} });
        function updateKeyboardLogic() {
            let x=0,y=0; if(keys.w)y=100; if(keys.s)y=-100; if(keys.a)x=-100; if(keys.d)x=100;
            if(y!==0&&x!==0)x*=0.5; 
            lastJoyX = x; lastJoyY = y;
            updateTankLogic(x,y);
        }

        // Gyro
        function toggleGyro() {
            if (!window.DeviceOrientationEvent) { alert("–ù–µ–º–∞—î –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –≥—ñ—Ä–æ—Å–∫–æ–ø–∞"); return; }
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(s => { if(s==='granted') activateGyro(); else alert("–í—ñ–¥–º–æ–≤–ª–µ–Ω–æ"); });
            } else { activateGyro(); }
        }
        function activateGyro() {
            isGyroEnabled = !isGyroEnabled;
            if (isGyroEnabled) {
                gyroBtn.classList.add('gyro-active'); 
                gyroCalibrated = false; // Flag to reset center on next move
                window.addEventListener('deviceorientation', handleGyro);
            } else {
                gyroBtn.classList.remove('gyro-active'); window.removeEventListener('deviceorientation', handleGyro); resetJoystick();
            }
        }
        function handleGyro(e) {
            if (!isGyroEnabled) return;
            
            // Calibration Logic: Set current position as 0
            if (!gyroCalibrated) {
                gyroOffset.x = e.gamma;
                gyroOffset.y = e.beta;
                gyroCalibrated = true;
                return; // Skip first frame
            }

            // Calculate relative to offset
            let x = e.gamma - gyroOffset.x;
            let y = e.beta - gyroOffset.y;
            
            const maxTilt = 30;
            if (x > maxTilt) x = maxTilt; if (x < -maxTilt) x = -maxTilt;
            if (y > maxTilt) y = maxTilt; if (y < -maxTilt) y = -maxTilt;
            
            let valX = Math.round((x / maxTilt) * 100);
            let valY = Math.round((y / maxTilt) * 100); 
            
            if (Math.abs(valX) < 10) valX = 0; if (Math.abs(valY) < 10) valY = 0;
            valY = -valY;
            
            const moveX = (valX / 100) * maxDist;
            const moveY = (-valY / 100) * maxDist;
            stick.style.transform = `translate(-50%, -50%) translate(${moveX}px, ${moveY}px)`;
            
            lastJoyX = valX; lastJoyY = valY;
            updateTankLogic(valX, valY);
        }

        function startJoy(e) { if(activeView!=='view-joystick'||isGyroEnabled)return; dragging=true; stick.classList.remove('snap-back'); const r=base.getBoundingClientRect(); joyCenter={x:r.left+r.width/2,y:r.top+r.height/2}; stick.classList.add('braking'); }
        function endJoy() { if(activeView!=='view-joystick'||isGyroEnabled)return; dragging=false; if(navigator.vibrate)navigator.vibrate(5); stick.classList.remove('braking'); resetJoystick(); }
        function resetJoystick() { 
            stick.classList.add('snap-back'); 
            stick.style.transform = `translate(-50%, -50%)`; 
            lastJoyX = 0; lastJoyY = 0;
            updateTankLogic(0,0); 
        }
        function moveJoy(e) {
            if(!dragging||isGyroEnabled)return; e.preventDefault();
            const cx=e.touches?e.touches[0].clientX:e.clientX; const cy=e.touches?e.touches[0].clientY:e.clientY;
            const dx=cx-joyCenter.x; const dy=cy-joyCenter.y;
            const dist=Math.min(Math.hypot(dx,dy),maxDist); const angle=Math.atan2(dy,dx);
            
            if(dist<10) stick.classList.add('braking'); else stick.classList.remove('braking');
            
            const mx=Math.cos(angle)*dist; const my=Math.sin(angle)*dist;
            stick.style.transform=`translate(-50%,-50%) translate(${mx}px,${my}px)`;
            
            const vx=Math.round((mx/maxDist)*100); const vy=Math.round((my/maxDist)*100)*-1;
            lastJoyX = vx; lastJoyY = vy;
            updateTankLogic(vx,vy);
        }
        
        function updateTankLogic(vx, vy) {
            let vL = vy + vx; 
            let vR = vy - vx;
            
            // 1. Initial Logic
            // Apply Trim/Invert
            if (tuning.trim > 0) vR = vR * (1 - (tuning.trim / 100));
            else if (tuning.trim < 0) vL = vL * (1 - (Math.abs(tuning.trim) / 100));
            if (tuning.invertL) vL = -vL;
            if (tuning.invertR) vR = -vR;
            
            // 2. Apply Speed Multiplier
            vL = Math.round(vL * speedMultiplier);
            vR = Math.round(vR * speedMultiplier);

            // 3. Clamping to -100..100 (Just in case, though multiplier should keep it in range)
            vL = Math.max(-100, Math.min(100, vL));
            vR = Math.max(-100, Math.min(100, vR));
            
            currentL = vL; currentR = vR;
            
            // Update Display
            motorLDisplay.innerText = currentL; 
            motorRDisplay.innerText = currentR;
            
            // Update HEX
            const raw = new Int8Array([currentL, currentR, 10]);
            const uintView = new Uint8Array(raw.buffer); 
            let hex = "";
            for(let b of uintView) hex += b.toString(16).toUpperCase().padStart(2,'0') + " ";
            joyHex.innerText = hex;
        }

        base.addEventListener('mousedown', startJoy); base.addEventListener('touchstart', startJoy);
        window.addEventListener('mouseup', endJoy); window.addEventListener('touchend', endJoy);
        window.addEventListener('mousemove', moveJoy); window.addEventListener('touchmove', moveJoy, {passive:false});

        // Dual Mode Logic
        const dualState = { lx: 0, ly: 0, rx: 0, ry: 0, btnL: 0, btnR: 0 };
        let btnValues = { L: 1, R: 1 };
        let protocol = [
            { type: 'axis', src: 'lx' }, { type: 'axis', src: 'ly' },
            { type: 'axis', src: 'rx' }, { type: 'axis', src: 'ry' },
            { type: 'btn', src: 'btnL' }, { type: 'btn', src: 'btnR' },
            { type: 'const', val: 10 }
        ];

        function initDualJoystick(baseId, stickId, prefix) {
            const base = document.getElementById(baseId);
            const stick = document.getElementById(stickId);
            const maxDist = 40;
            let activeTouchId = null;

            function update(cx, cy) {
                const rect = base.getBoundingClientRect();
                const dx = cx - (rect.left + rect.width/2); 
                const dy = cy - (rect.top + rect.height/2);
                const dist = Math.min(Math.hypot(dx, dy), maxDist);
                const angle = Math.atan2(dy, dx);
                const mx = Math.cos(angle) * dist; 
                const my = Math.sin(angle) * dist;
                stick.style.transform = `translate(-50%, -50%) translate(${mx}px, ${my}px)`;
                dualState[prefix+'x'] = Math.round((mx/maxDist)*100);
                dualState[prefix+'y'] = Math.round((my/maxDist)*100)*-1;
            }
            function reset() {
                stick.classList.add('snap');
                stick.style.transform = `translate(-50%, -50%)`;
                dualState[prefix+'x'] = 0;
                dualState[prefix+'y'] = 0;
            }
            base.addEventListener('mousedown', (e) => {
                stick.classList.remove('snap'); update(e.clientX, e.clientY);
                const mm = (ev) => update(ev.clientX, ev.clientY);
                const mu = () => { window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); reset(); };
                window.addEventListener('mousemove', mm); window.addEventListener('mouseup', mu);
            });
            base.addEventListener('touchstart', (e) => { e.preventDefault(); stick.classList.remove('snap'); activeTouchId = e.changedTouches[0].identifier; update(e.changedTouches[0].clientX, e.changedTouches[0].clientY); });
            base.addEventListener('touchmove', (e) => { e.preventDefault(); for(let i=0; i<e.changedTouches.length; i++) { if(e.changedTouches[i].identifier === activeTouchId) { update(e.changedTouches[i].clientX, e.changedTouches[i].clientY); break; } } });
            base.addEventListener('touchend', (e) => { e.preventDefault(); for(let i=0; i<e.changedTouches.length; i++) { if(e.changedTouches[i].identifier === activeTouchId) { activeTouchId = null; reset(); break; } } });
        }
        setTimeout(() => { initDualJoystick('joyL-base', 'joyL-stick', 'l'); initDualJoystick('joyR-base', 'joyR-stick', 'r'); }, 500);

        function setBtn(side, pressed) { if(pressed && navigator.vibrate) navigator.vibrate(20); dualState['btn'+side] = pressed ? btnValues[side] : 0; }
        let currentCfgBtn = null;
        function configBtn(side) { currentCfgBtn = side; document.getElementById('btnValInput').value = btnValues[side]; document.getElementById('valueConfigModal').classList.remove('hidden'); }
        function saveBtnConfig() { const val = parseInt(document.getElementById('btnValInput').value); if(!isNaN(val) && val >= 0 && val <= 255) { btnValues[currentCfgBtn] = val; document.getElementById('valDisp'+currentCfgBtn).innerText = val; } document.getElementById('valueConfigModal').classList.add('hidden'); }
        function openProtocolModal() { renderProtocolList(); document.getElementById('protocolModal').classList.remove('hidden'); }
        function renderProtocolList() {
            const list = document.getElementById('byteList'); list.innerHTML = '';
            protocol.forEach((item, index) => {
                const el = document.createElement('div'); el.className = 'flex justify-between items-center bg-slate-800 p-2 rounded mb-2 border border-slate-600';
                let options = `<select onchange="updateByte(${index}, 'type', this.value)" class="bg-slate-900 text-xs rounded p-1 text-white"><option value="axis" ${item.type==='axis'?'selected':''}>–í—ñ—Å—å</option><option value="btn" ${item.type==='btn'?'selected':''}>–ö–Ω–æ–ø–∫–∞</option><option value="const" ${item.type==='const'?'selected':''}>–ö–æ–Ω—Å—Ç</option></select>`;
                let valInp = item.type === 'const' ? `<input type="number" value="${item.val}" onchange="updateByte(${index}, 'val', this.value)" class="w-12 bg-slate-900 text-xs text-center rounded text-white">` : `<select onchange="updateByte(${index}, 'src', this.value)" class="w-16 bg-slate-900 text-xs rounded text-white"><option value="lx" ${item.src==='lx'?'selected':''}>LX</option><option value="ly" ${item.src==='ly'?'selected':''}>LY</option><option value="rx" ${item.src==='rx'?'selected':''}>RX</option><option value="ry" ${item.src==='ry'?'selected':''}>RY</option><option value="btnL" ${item.src==='btnL'?'selected':''}>BtnL</option><option value="btnR" ${item.src==='btnR'?'selected':''}>BtnR</option></select>`;
                el.innerHTML = `<span class="text-xs text-slate-400 font-mono">B${index}</span>${options}${valInp}<button onclick="removeByte(${index})" class="text-red-500"><i class="fa-solid fa-trash"></i></button>`;
                list.appendChild(el);
            });
        }
        function updateByte(i, k, v) { protocol[i][k] = k==='val'?parseInt(v):v; if(k==='type') renderProtocolList(); }
        function addByte() { protocol.push({ type: 'const', val: 0 }); renderProtocolList(); }
        function removeByte(i) { protocol.splice(i, 1); renderProtocolList(); }
        function saveProtocol() { document.getElementById('protocolModal').classList.add('hidden'); }
        setInterval(() => {
            if(activeView === 'view-dual') {
                const packet = new Int8Array(protocol.length); let hexStr = "";
                protocol.forEach((byteCfg, i) => {
                    let val = 0;
                    if(byteCfg.type === 'axis') val = dualState[byteCfg.src]; else if(byteCfg.type === 'btn') val = dualState[byteCfg.src]; else if(byteCfg.type === 'const') val = byteCfg.val;
                    packet[i] = val; hexStr += (val & 0xFF).toString(16).toUpperCase().padStart(2, '0') + " ";
                });
                document.getElementById('dualPacketHex').innerText = hexStr;
                if(isConnected) sendRawPacket(packet);
            }
        }, 100);

        // === BLOCKLY & SCRATCH ===
        const CustomTheme = Blockly.Theme.defineTheme('myTheme', {
            'base': Blockly.Themes.Classic,
            'componentStyles': {
                'workspaceBackgroundColour': '#0f172a', 'toolboxBackgroundColour': THEME_CONFIG.menuBg, 'toolboxForegroundColour': THEME_CONFIG.menuText, 'flyoutBackgroundColour': THEME_CONFIG.flyoutBg, 'flyoutForegroundColour': THEME_CONFIG.menuText, 'flyoutOpacity': THEME_CONFIG.flyoutOpacity, 'scrollbarColour': '#334155', 'insertionMarkerColour': '#fff', 'insertionMarkerOpacity': 0.3
            }
        });

        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'), theme: CustomTheme, renderer: 'zelos', horizontalLayout: true, toolboxPosition: 'end', grid: { spacing: 30, length: 3, colour: '#475569', snap: true }, zoom: { controls: false, wheel: true, startScale: 0.9, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 }, trashcan: true, move: { scrollbars: false, drag: true, wheel: true }
        });
        
        setTimeout(() => {
            const style = document.createElement('style');
            style.innerHTML = `.blocklyToolboxDiv { background-color: ${THEME_CONFIG.menuBg} !important; } .blocklyFlyoutBackground { fill: ${THEME_CONFIG.flyoutBg} !important; fill-opacity: ${THEME_CONFIG.flyoutOpacity} !important; } .blocklyTreeLabel { color: ${THEME_CONFIG.menuText} !important; } .blocklyTreeSelected .blocklyTreeRow { background-color: ${THEME_CONFIG.menuSelected} !important; }`;
            document.head.appendChild(style);
        }, 500);

        Blockly.Blocks['start_hat'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("üèÅ –°–¢–ê–†–¢")
                    .appendField(new Blockly.FieldImage("https://upload.wikimedia.org/wikipedia/commons/2/21/Play_icon_green.svg", 24, 24, "Play", this.onRunClick.bind(this)), "RUN_ICON");
                this.setNextStatement(true);
                this.setColour(120);
                this.isRunning = false;
            },
            onRunClick: function(img) {
                if(this.sourceBlock_.isRunning) {
                    stopCode();
                    img.setValue("https://upload.wikimedia.org/wikipedia/commons/2/21/Play_icon_green.svg");
                    this.sourceBlock_.isRunning = false;
                } else {
                    runCode();
                    img.setValue("https://upload.wikimedia.org/wikipedia/commons/4/47/Stop_icon_red.svg");
                    this.sourceBlock_.isRunning = true;
                }
            }
        };
        javascript.javascriptGenerator.forBlock['start_hat'] = function(b) { return ''; };

        Blockly.Blocks['robot_move'] = { init: function() { this.appendDummyInput().appendField("üöó –á—Ö–∞—Ç–∏").appendField("L").appendField(new Blockly.FieldTextInput("100"), "L").appendField("R").appendField(new Blockly.FieldTextInput("100"), "R"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(230); } };
        javascript.javascriptGenerator.forBlock['robot_move'] = function(b) {
            var l = b.getFieldValue('L'); var r = b.getFieldValue('R');
            return `recordMove(${l}, ${r}); await sendDrivePacket(${l}, ${r});\n`;
        };

        Blockly.Blocks['move_3_motors'] = { init: function() { this.appendDummyInput().appendField("üöÄ 3 –ú–æ—Ç–æ—Ä–∏").appendField("M1").appendField(new Blockly.FieldTextInput("100"), "M1").appendField("M2").appendField(new Blockly.FieldTextInput("100"), "M2").appendField("M3").appendField(new Blockly.FieldTextInput("100"), "M3"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(260); } };
        javascript.javascriptGenerator.forBlock['move_3_motors'] = function(block) {
            var m1 = block.getFieldValue('M1'); var m2 = block.getFieldValue('M2'); var m3 = block.getFieldValue('M3');
            return `await bt_move3(${m1}, ${m2}, ${m3});\n`;
        };

        Blockly.Blocks['robot_stop'] = { init: function() { this.appendDummyInput().appendField("üõë –°—Ç–æ–ø"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(0); } };
        javascript.javascriptGenerator.forBlock['robot_stop'] = function() { return `recordMove(0,0); await sendDrivePacket(0,0);\n`; };

        Blockly.Blocks['wait_seconds'] = { init: function() { this.appendDummyInput().appendField("‚è≥ –ß–µ–∫–∞—Ç–∏").appendField(new Blockly.FieldTextInput("1"), "S"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(40); } };
        javascript.javascriptGenerator.forBlock['wait_seconds'] = function(b) { return `recordWait(${b.getFieldValue('S')}); await new Promise(r => setTimeout(r, ${b.getFieldValue('S')*1000}));\n`; };

        Blockly.Blocks['sensor_get'] = { init: function() { this.appendDummyInput().appendField("üëÅÔ∏è –î–∞—Ç—á–∏–∫"); this.setOutput(true, "Number"); this.setColour(180); } };
        javascript.javascriptGenerator.forBlock['sensor_get'] = function() { return ['window.sensorVal', javascript.Order.ATOMIC]; };

        Blockly.Blocks['go_home'] = { init: function() { this.appendDummyInput().appendField("üè† –î–æ–¥–æ–º—É (–ù–∞–∑–∞–¥)"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(290); } };
        javascript.javascriptGenerator.forBlock['go_home'] = function() { return 'await goHomeSequence();\n'; };

        // Execution
        let moveHistory = [];
        let isCodeRunning = false;
        function recordMove(l, r) { if(isCodeRunning) moveHistory.push({ type: 'move', l: parseInt(l), r: parseInt(r) }); }
        function recordWait(sec) { if(isCodeRunning) moveHistory.push({ type: 'wait', sec: parseFloat(sec) }); }

        async function goHomeSequence() {
            for (let i = moveHistory.length - 1; i >= 0; i--) {
                const action = moveHistory[i];
                if (action.type === 'wait') await new Promise(r => setTimeout(r, action.sec * 1000));
                else if (action.type === 'move') await sendDrivePacket(-action.l, -action.r);
            }
            await sendDrivePacket(0, 0); moveHistory = [];
        }

        window.toggleRunState = function() { if(isCodeRunning) stopCode(); else runCode(); };
        window.runCode = async function() {
            if(typeof isConnected !== 'undefined' && !isConnected) { alert('–°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –¥–æ Bluetooth!'); return; }
            isCodeRunning = true; moveHistory = [];
            globalRunBtn.classList.add('running'); runIcon.classList.remove('fa-play'); runIcon.classList.add('fa-stop'); runIcon.classList.add('ml-0');
            const code = javascript.javascriptGenerator.workspaceToCode(workspace);
            try { const runner = new Function(`return (async () => { ${code} })();`); await runner(); } catch(e) { console.error(e); } 
            finally { if(isCodeRunning) stopCode(); }
        };
        window.stopCode = function() { 
            sendDrivePacket(0,0); isCodeRunning = false;
            globalRunBtn.classList.remove('running'); runIcon.classList.remove('fa-stop'); runIcon.classList.add('fa-play'); runIcon.classList.remove('ml-0');
        };

        window.showGeneratedCode = function() {
            const code = javascript.javascriptGenerator.workspaceToCode(workspace);
            codeDisplay.textContent = code || "// No blocks in workspace";
            document.getElementById('codeModal').classList.remove('hidden');
        }

        // Expose functions for generated code
        window.sendDrivePacket = sendDrivePacket;
    </script>
</body>
</html>
